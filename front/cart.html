<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>我的购物车</title>
    <link href="../bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/style.css" rel="stylesheet">
</head>
<body>

<nav class="navbar navbar-default">
  <div class="container-fluid">
    <div class="navbar-header">
      <a class="navbar-brand" href="#">小型购书网</a>
    </div>
    <ul class="nav navbar-nav">
      <li><a href="bookList.html">首页</a></li>
      <li class="active"><a href="cart.html">购物车</a></li>
    </ul>
    <ul class="nav navbar-nav navbar-right" id="nav-user-area"></ul>
  </div>
</nav>

<div class="container">
    <div class="row">
        <div class="col-md-12">
            <h3><span class="glyphicon glyphicon-shopping-cart"></span> 购物车列表</h3>
            <hr>
            <table class="table table-striped table-hover table-bordered">
                <thead>
                    <tr class="info">
                        <th>封面</th>
                        <th>书名</th>
                        <th>单价</th>
                        <th>数量</th>
                        <th>小计</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="cart-body"></tbody>
                <tfoot>
                    <tr>
                        <td colspan="6" class="text-right">
                            <span style="font-size: 18px; margin-right: 20px;">总价：<strong class="text-danger" id="totalPrice">￥0.00</strong></span>
                            <a href="bookList.html" class="btn btn-default">继续购物</a>
                            <a href="javascript:void(0);" onclick="clearCart()" class="btn btn-warning">清空购物车</a>
                            <a href="order.html" class="btn btn-success">确认下单</a>
                        </td>
                    </tr>
                </tfoot>
            </table>
            <div id="empty-cart-msg" class="alert alert-info text-center" style="display:none;">
                您的购物车是空的，快去选购吧！<a href="bookList.html">去首页</a>
            </div>
        </div>
    </div>
</div>

<script src="../script/jquery-3.7.1.min.js"></script>
<script src="../bootstrap/js/bootstrap.min.js"></script>
<script>
    $(function(){
        // 1. 登录状态
        var user = sessionStorage.getItem("currentUser");
        var $nav = $("#nav-user-area");
        if(user) {
            $nav.html('<li><p class="navbar-text">你好，'+user+'</p></li><li><a href="#" onclick="logout()">退出</a></li>');
        } else {
            $nav.html('<li><a href="login.html">登录</a></li><li><a href="register.html">注册</a></li>');
        }

        renderCart();
    });

    function logout() { sessionStorage.removeItem("currentUser"); window.location.href = "login.html"; }

    // 2. 渲染购物车
    function renderCart() {
        var cart = JSON.parse(sessionStorage.getItem('myCart')) || [];
        var $tbody = $("#cart-body");
        $tbody.empty();

        if(cart.length === 0) {
            $("#empty-cart-msg").show();
            $("table").hide();
            return;
        }

        $("table").show();
        $("#empty-cart-msg").hide();

        $.each(cart, function(index, item){
            var subtotal = item.price * item.qty;
            var html = `
                <tr data-id="${item.id}">
                    <td><img src="${item.img}" height="50px"></td>
                    <td>${item.title}</td>
                    <td class="price">${item.price.toFixed(2)}</td>
                    <td><input type="number" value="${item.qty}" min="1" class="form-control input-sm qty" style="width:60px;" onchange="updateQty(${item.id}, this.value)"></td>
                    <td class="subtotal text-danger">￥${subtotal.toFixed(2)}</td>
                    <td><button class="btn btn-danger btn-xs" onclick="removeItem(${item.id})">删除</button></td>
                </tr>
            `;
            $tbody.append(html);
        });

        updateTotal(cart);
    }

    // 更新数量
    window.updateQty = function(id, newQty) {
        if(newQty < 1) return;
        var cart = JSON.parse(sessionStorage.getItem('myCart')) || [];
        var item = cart.find(i => i.id === id);
        if(item) {
            item.qty = parseInt(newQty);
            sessionStorage.setItem('myCart', JSON.stringify(cart));
            renderCart(); // 重新渲染以更新小计和总价
        }
    }

    // 删除商品
    window.removeItem = function(id) {
        if(!confirm("确定要删除吗？")) return;
        var cart = JSON.parse(sessionStorage.getItem('myCart')) || [];
        cart = cart.filter(i => i.id !== id);
        sessionStorage.setItem('myCart', JSON.stringify(cart));
        renderCart();
    }

    // 清空购物车
    window.clearCart = function() {
        if(!confirm("确定清空购物车吗？")) return;
        sessionStorage.removeItem('myCart');
        renderCart();
    }

    // 计算总价
    function updateTotal(cart) {
        var total = 0;
        cart.forEach(function(item){
            total += item.price * item.qty;
        });
        $("#totalPrice").text("￥" + total.toFixed(2));
    }
</script>
</body>
</html>